<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Flow - Pomodoro</title>
    <meta name="theme-color" id="theme-color-meta" content="#f1f5f9">
    
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;700;900&display=swap" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/tone/14.7.77/Tone.js"></script>

    <style>
        body {
            font-family: 'Inter', sans-serif;
            overflow: hidden;
            position: relative;
            transition: background-color 1s ease-in-out;
        }

    /* Respect des widgets natifs en mode sombre */
    body.theme-night { color-scheme: dark; }

        body::before,
        body::after {
            content: '';
            position: fixed;
            top: 50%;
            left: 50%;
            width: 150vmax;
            height: 150vmax;
            border-radius: 50%;
            z-index: -1;
            opacity: 0.3;
            filter: blur(100px);
            will-change: transform, border-radius;
            animation: rotate 25s linear infinite;
            transition: background 1s ease-in-out;
        }

        /* --- THEME JOUR --- */
        .theme-day.state-idle { background-color: #f1f5f9; color: #0a0a0a; }
        .theme-day.state-idle::before { background: radial-gradient(circle, #e2e8f0, transparent 60%); }
        .theme-day.state-idle::after { background: radial-gradient(circle, #cbd5e1, transparent 60%); animation-direction: reverse; }
        .theme-day.state-work { background-color: #eef2ff; color: #0a0a0a; }
        .theme-day.state-work::before { background: radial-gradient(circle, #fb7185, transparent 60%); }
        .theme-day.state-work::after { background: radial-gradient(circle, #818cf8, transparent 60%); animation-direction: reverse; }
        .theme-day.state-break { background-color: #ecfdf5; color: #0a0a0a; }
        .theme-day.state-break::before { background: radial-gradient(circle, #34d399, transparent 60%); }
        .theme-day.state-break::after { background: radial-gradient(circle, #38bdf8, transparent 60%); animation-direction: reverse; }

        /* --- NOUVEAU: THEME NUIT "PITCH BLACK" --- */
        .theme-night.state-idle { background-color: #000000; color: #e2e8f0; }
        .theme-night.state-idle::before { background: radial-gradient(circle, #1e293b, transparent 60%); opacity: 0.2; }
        .theme-night.state-idle::after { background: radial-gradient(circle, #0f172a, transparent 60%); opacity: 0.2; animation-direction: reverse; }
        .theme-night.state-work { background-color: #02042b; color: #e2e8f0; }
        .theme-night.state-work::before { background: radial-gradient(circle, #831843, transparent 60%); opacity: 0.3; }
        .theme-night.state-work::after { background: radial-gradient(circle, #312e81, transparent 60%); opacity: 0.3; animation-direction: reverse; }
        .theme-night.state-break { background-color: #0c1427; color: #e2e8f0; }
        .theme-night.state-break::before { background: radial-gradient(circle, #0f766e, transparent 60%); opacity: 0.3; }
        .theme-night.state-break::after { background: radial-gradient(circle, #075985, transparent 60%); opacity: 0.3; animation-direction: reverse; }

        @keyframes rotate {
            0% { transform: translate(-50%, -50%) rotate(0deg) scale(1); }
            100% { transform: translate(-50%, -50%) rotate(360deg) scale(1.1); }
        }

        .glass-container {
            background: var(--glass-bg);
            backdrop-filter: blur(30px);
            -webkit-backdrop-filter: blur(30px);
            border: 1px solid var(--glass-border);
            transition: opacity 0.5s ease-in-out, transform 0.5s ease-in-out, background 1s, border 1s;
        }
        .theme-day .glass-container { --glass-bg: rgba(255, 255, 255, 0.3); --glass-border: rgba(0, 0, 0, 0.1); }
        .theme-night .glass-container { --glass-bg: rgba(10, 10, 10, 0.2); --glass-border: rgba(255, 255, 255, 0.1); }

        .timer-gradient { background-clip: text; -webkit-background-clip: text; color: transparent; transition: background-image 1s ease-in-out; }
        .theme-day .timer-idle { background-image: linear-gradient(45deg, #334155, #0f172a); }
        .theme-day .timer-work { background-image: linear-gradient(45deg, #f43f5e, #6366f1); }
        .theme-day .timer-break { background-image: linear-gradient(45deg, #10b981, #0ea5e9); }
        .theme-night .timer-idle { background-image: linear-gradient(45deg, #d4d4d8, #fafafa); }
        .theme-night .timer-work { background-image: linear-gradient(45deg, #fda4af, #a5b4fc); }
        .theme-night .timer-break { background-image: linear-gradient(45deg, #6ee7b7, #7dd3fc); }

        .ultra-focus-active .glass-container,
        .ultra-focus-active footer,
        .ultra-focus-active .top-controls {
            opacity: 0; pointer-events: none; transform: scale(0.95);
        }

        /* --- TOGGLE THEME minimaliste --- */
        .theme-toggle { position: relative; width: 56px; height: 32px; border-radius: 9999px; border: 1px solid var(--glass-border); display: flex; align-items: center; padding: 2px; background: rgba(255,255,255,0.4); backdrop-filter: blur(10px); -webkit-backdrop-filter: blur(10px); transition: background .4s ease, border-color .4s ease; }
        .theme-night .theme-toggle { background: rgba(0,0,0,0.4); }
        .theme-toggle .knob { position: absolute; top: 2px; left: 2px; width: 28px; height: 28px; border-radius: 9999px; background: linear-gradient(145deg, #ffffff, #e5e7eb); box-shadow: 0 2px 10px rgba(0,0,0,.15); transition: transform .35s cubic-bezier(.4,0,.2,1), background .4s ease, box-shadow .4s ease; }
        .theme-night .theme-toggle .knob { background: linear-gradient(145deg, #0f172a, #020617); box-shadow: 0 2px 12px rgba(0,0,0,.5); }
        .theme-toggle.is-dark .knob { transform: translateX(24px); }
        .theme-toggle .icon { width: 18px; height: 18px; z-index: 1; opacity: .85; transition: opacity .35s ease, transform .35s ease; color: currentColor; }
        .theme-toggle .icon-sun { margin-left: 8px; }
        .theme-toggle .icon-moon { margin-left: auto; margin-right: 8px; }
        .theme-toggle.is-dark .icon-sun { opacity: .35; }
        .theme-toggle.is-dark .icon-moon { opacity: 1; }
        @media (prefers-reduced-motion: reduce) { * { animation-duration: .01ms !important; animation-iteration-count: 1 !important; transition-duration: 0.01ms !important; scroll-behavior: auto !important; } }
        .theme-day ::placeholder { color: rgba(15,23,42,0.5); }
        .theme-night ::placeholder { color: rgba(226,232,240,0.5); }
    </style>
</head>
<body>

    <div class="top-controls absolute top-6 right-6 z-20 flex items-center space-x-4 transition-all duration-500">
        <!-- Toggle Thème: Sun/Moon minimaliste -->
        <button id="theme-toggle" class="theme-toggle" aria-label="Basculer le thème" aria-pressed="false" title="Thème (touche D)">
            <svg class="icon icon-sun" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                <circle cx="12" cy="12" r="4"></circle>
                <path d="M12 2v2m0 16v2M4.93 4.93l1.41 1.41M17.66 17.66l1.41 1.41M2 12h2m16 0h2M4.93 19.07l1.41-1.41M17.66 6.34l1.41-1.41"/>
            </svg>
            <svg class="icon icon-moon" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                <path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"/>
            </svg>
            <span class="knob" aria-hidden="true"></span>
        </button>
        <!-- NOUVEAU: Bouton Ultra-Focus plus grand -->
        <button id="ultra-focus-btn" class="control-btn bg-black/20 hover:bg-black/40 w-14 h-14 flex items-center justify-center">
            <svg xmlns="http://www.w3.org/2000/svg" width="28" height="28" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z"></path><circle cx="12" cy="12" r="3"></circle></svg>
        </button>
    </div>

    <main id="main-content" class="min-h-screen w-full flex flex-col items-center justify-center p-4 transition-all duration-1000">
        <div class="glass-container w-full max-w-lg mx-auto rounded-3xl shadow-2xl p-6 sm:p-10 text-center">
            <div id="mode-selector" class="flex justify-center space-x-2 sm:space-x-4 mb-8">
                <button data-mode="pomodoro" class="mode-btn">Pomodoro</button>
                <button data-mode="shortBreak" class="mode-btn">Pause Courte</button>
                <button data-mode="longBreak" class="mode-btn">Pause Longue</button>
            </div>
            <div id="timer-display" class="font-black text-7xl sm:text-8xl md:text-9xl tracking-tighter mb-4 transition-all duration-300 transform timer-gradient cursor-pointer">25:00</div>
            <div class="h-12 flex items-center justify-center mb-4">
                 <input type="text" id="intention-input" placeholder="Quelle est votre intention ?" class="w-full max-w-xs bg-transparent border-b text-center text-lg focus:outline-none transition-all duration-300">
                 <p id="intention-display" class="text-lg hidden"></p>
            </div>
            <div class="flex justify-center items-center space-x-4">
                <button id="start-pause-btn" class="control-btn control-btn-primary w-32">Démarrer</button>
                <button id="reset-btn" class="control-btn w-12 h-12 flex items-center justify-center">
                    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M3 2v6h6"/><path d="M21 12A9 9 0 0 0 6 5.3L3 8"/><path d="M21 22v-6h-6"/><path d="M3 12a9 9 0 0 0 15 6.7l3-2.7"/></svg>
                </button>
            </div>
            <div id="pomodoro-counter" class="flex justify-center space-x-3 mt-8">
                <div class="cycle-dot"></div><div class="cycle-dot"></div><div class="cycle-dot"></div><div class="cycle-dot"></div>
            </div>
        </div>
        <footer class="absolute bottom-4 text-sm transition-opacity duration-500">Créé avec une philosophie de concentration.</footer>
    </main>
    
    <div id="settings-modal" class="fixed inset-0 z-30 bg-black/30 backdrop-blur-md flex items-center justify-center p-4 hidden">
        <div class="glass-container w-full max-w-sm rounded-2xl p-6">
            <h3 class="text-xl font-bold mb-6 text-center">Durées (minutes)</h3>
            <div class="space-y-4">
                <div class="flex justify-between items-center"><label for="pomodoro-duration">Pomodoro</label><input type="number" id="pomodoro-duration" class="setting-input"></div>
                <div class="flex justify-between items-center"><label for="shortbreak-duration">Pause Courte</label><input type="number" id="shortbreak-duration" class="setting-input"></div>
                <div class="flex justify-between items-center"><label for="longbreak-duration">Pause Longue</label><input type="number" id="longbreak-duration" class="setting-input"></div>
            </div>
            <button id="save-settings-btn" class="w-full mt-8 control-btn">Fermer</button>
        </div>
    </div>

    <script>
        // --- DOM Elements & State ---
        const elements = { body: document.body, mainContent: document.getElementById('main-content'), timerDisplay: document.getElementById('timer-display'), startPauseBtn: document.getElementById('start-pause-btn'), resetBtn: document.getElementById('reset-btn'), modeButtons: document.querySelectorAll('.mode-btn'), intentionInput: document.getElementById('intention-input'), intentionDisplay: document.getElementById('intention-display'), cycleDots: document.querySelectorAll('#pomodoro-counter .cycle-dot'), ultraFocusBtn: document.getElementById('ultra-focus-btn'), settingsModal: document.getElementById('settings-modal'), saveSettingsBtn: document.getElementById('save-settings-btn'), themeToggle: document.getElementById('theme-toggle') };
        let timers = { pomodoro: 25, shortBreak: 5, longBreak: 15 };
        const SESSIONS_BEFORE_LONG_BREAK = 4;
        let state = { currentMode: 'pomodoro', timeRemaining: 0, timerId: null, isRunning: false, pomodoroCount: 0 };

        // --- Sound Engine ---
        let notificationSynth;
        const initSounds = () => {
            const chorus = new Tone.Chorus(4, 2.5, 0.2).start();
            const reverb = new Tone.Reverb({ decay: 2.5, wet: 0.25 });
            notificationSynth = new Tone.FMSynth({
                harmonicity: 3,
                modulationIndex: 10,
                oscillator: { type: 'sine' },
                modulation: { type: 'sine' },
                envelope: { attack: 0.005, decay: 1.2, sustain: 0.0, release: 1.6 },
                modulationEnvelope: { attack: 0.005, decay: 0.2, sustain: 0.0, release: 0.2 }
            }).chain(chorus, reverb, Tone.Destination);
        };
        const playNotificationSound = () => {
            const now = Tone.now();
            // Petit motif de cloche agréable
            notificationSynth?.triggerAttackRelease('C6', '8n', now);
            notificationSynth?.triggerAttackRelease('G5', '8n', now + 0.15);
        };
        // Ambient sound removed; keep only end-of-session ring.

        // --- Core Functions ---
        const updateDisplay = () => {
            const minutes = Math.floor(state.timeRemaining / 60).toString().padStart(2, '0');
            const seconds = (state.timeRemaining % 60).toString().padStart(2, '0');
            elements.timerDisplay.textContent = `${minutes}:${seconds}`;
            document.title = `${minutes}:${seconds} - Flow`;
        };
        const updateCounterUI = () => elements.cycleDots.forEach((dot, i) => dot.style.backgroundColor = i < state.pomodoroCount ? 'var(--counter-fill)' : 'var(--counter-empty)');
        const tick = () => {
            state.timeRemaining--;
            updateDisplay();
            if (state.timeRemaining < 0) {
                playNotificationSound();
                if (state.currentMode === 'pomodoro') {
                    state.pomodoroCount++;
                    switchMode(state.pomodoroCount >= SESSIONS_BEFORE_LONG_BREAK ? 'longBreak' : 'shortBreak');
                    if (state.pomodoroCount >= SESSIONS_BEFORE_LONG_BREAK) state.pomodoroCount = 0;
                    updateCounterUI();
                } else { switchMode('pomodoro'); }
            }
        };
        const manageIntention = (showInput) => {
            elements.intentionInput.classList.toggle('hidden', !showInput);
            elements.intentionDisplay.classList.toggle('hidden', showInput);
            if (!showInput) elements.intentionDisplay.textContent = elements.intentionInput.value || "Rester concentré";
        };
        const updateThemeAndColors = () => {
            const isNight = elements.body.classList.contains('theme-night');
            document.documentElement.style.setProperty('--counter-fill', isNight ? '#e2e8f0' : '#0f172a');
            document.documentElement.style.setProperty('--counter-empty', isNight ? 'rgba(226, 232, 240, 0.2)' : 'rgba(15, 23, 42, 0.2)');
            elements.modeButtons.forEach(b => b.style.backgroundColor = b.dataset.mode === state.currentMode ? (isNight ? 'rgba(255,255,255,0.2)' : 'rgba(0,0,0,0.1)') : '');
            elements.intentionInput.style.borderColor = isNight ? 'rgba(255,255,255,0.2)' : 'rgba(0,0,0,0.2)';
            elements.intentionInput.style.color = isNight ? '#e2e8f0' : '#0f172a';
            elements.intentionDisplay.style.color = isNight ? 'rgba(226, 232, 240, 0.7)' : 'rgba(15, 23, 42, 0.7)';
            elements.resetBtn.style.backgroundColor = isNight ? 'rgba(255,255,255,0.1)' : 'rgba(0,0,0,0.05)';
        };
        const updateThemeToggleUI = () => {
            const isDark = elements.body.classList.contains('theme-night');
            elements.themeToggle?.setAttribute('aria-pressed', String(isDark));
            elements.themeToggle?.classList.toggle('is-dark', isDark);
        };
        const updateUIForState = () => {
            elements.timerDisplay.classList.remove('timer-idle', 'timer-work', 'timer-break');
            elements.body.classList.remove('state-idle', 'state-work', 'state-break');
            const isNight = elements.body.classList.contains('theme-night');

            if (state.isRunning) {
                if (state.currentMode === 'pomodoro') {
                    elements.body.classList.add('state-work');
                    elements.timerDisplay.classList.add('timer-work');
                    elements.startPauseBtn.style.backgroundColor = isNight ? '#831843' : '#f43f5e';
                } else {
                    elements.body.classList.add('state-break');
                    elements.timerDisplay.classList.add('timer-break');
                    elements.startPauseBtn.style.backgroundColor = isNight ? '#0f766e' : '#10b981';
                }
                elements.timerDisplay.classList.add('scale-105');
                elements.startPauseBtn.textContent = 'Pause';
                manageIntention(false);
            } else {
                elements.body.classList.add('state-idle');
                elements.timerDisplay.classList.add('timer-idle');
                elements.timerDisplay.classList.remove('scale-105');
                elements.startPauseBtn.style.backgroundColor = isNight ? '#fafafa' : '#0f172a';
                elements.startPauseBtn.textContent = state.isRunning || state.timeRemaining < timers[state.currentMode] * 60 ? 'Reprendre' : 'Démarrer';
                if (state.currentMode === 'pomodoro') manageIntention(true);
            }
            elements.startPauseBtn.style.color = (state.isRunning || !isNight) ? '#fafafa' : '#0f172a';
            updateThemeAndColors();
            updateThemeToggleUI();
        };
        const THEME_STORAGE_KEY = 'flow-theme';
        const applyTheme = (theme, persist = true) => {
            elements.body.classList.remove('theme-day', 'theme-night');
            const isDark = theme === 'dark';
            elements.body.classList.add(isDark ? 'theme-night' : 'theme-day');
            // Meta theme-color pour barres système
            const themeMeta = document.getElementById('theme-color-meta');
            if (themeMeta) themeMeta.setAttribute('content', isDark ? '#000000' : '#f1f5f9');
            // Indiquer au navigateur le schéma de couleur
            document.documentElement.style.colorScheme = isDark ? 'dark' : 'light';
            if (persist) localStorage.setItem(THEME_STORAGE_KEY, theme);
            updateUIForState();
        };
        const startTimer = async () => {
            if (state.isRunning) return;
            await Tone.start();
            if (!notificationSynth) initSounds();
            state.isRunning = true;
            state.timerId = setInterval(tick, 1000);
            updateUIForState();
        };
        const pauseTimer = () => {
            state.isRunning = false;
            clearInterval(state.timerId);
            state.timerId = null;
            updateUIForState();
        };
        const resetTimer = () => {
            pauseTimer();
            state.timeRemaining = timers[state.currentMode] * 60;
            updateDisplay();
            updateUIForState();
        };
        const switchMode = (mode) => {
            state.currentMode = mode;
            if (mode !== 'pomodoro') {
                elements.intentionInput.classList.add('hidden');
                elements.intentionDisplay.classList.add('hidden');
            }
            resetTimer();
        };
        let longPressTimer;
        elements.timerDisplay.addEventListener('mousedown', () => longPressTimer = setTimeout(() => elements.settingsModal.classList.remove('hidden'), 1000));
        elements.timerDisplay.addEventListener('mouseup', () => clearTimeout(longPressTimer));
        elements.timerDisplay.addEventListener('mouseleave', () => clearTimeout(longPressTimer));
        const closeSettings = () => {
            timers.pomodoro = parseInt(document.getElementById('pomodoro-duration').value) || 25;
            timers.shortBreak = parseInt(document.getElementById('shortbreak-duration').value) || 5;
            timers.longBreak = parseInt(document.getElementById('longbreak-duration').value) || 15;
            localStorage.setItem('flow-timers', JSON.stringify(timers));
            elements.settingsModal.classList.add('hidden');
            if (!state.isRunning) resetTimer();
        };

        // --- Event Listeners ---
        elements.startPauseBtn.addEventListener('click', () => state.isRunning ? pauseTimer() : startTimer());
        elements.resetBtn.addEventListener('click', resetTimer);
        elements.modeButtons.forEach(button => button.addEventListener('click', () => switchMode(button.dataset.mode)));
        elements.ultraFocusBtn.addEventListener('click', () => elements.body.classList.toggle('ultra-focus-active'));
        elements.mainContent.addEventListener('dblclick', () => elements.body.classList.contains('ultra-focus-active') && elements.body.classList.remove('ultra-focus-active'));
        elements.saveSettingsBtn.addEventListener('click', closeSettings);
    // Ambient sound button removed
        elements.themeToggle.addEventListener('click', () => {
            const isDark = elements.body.classList.contains('theme-night');
            applyTheme(isDark ? 'light' : 'dark');
        });
        // Raccourci clavier (D)
        document.addEventListener('keydown', (e) => {
            if (!e.ctrlKey && !e.metaKey && !e.altKey && e.key.toLowerCase() === 'd') {
                e.preventDefault();
                elements.themeToggle.click();
            }
        });
        
        // --- Initial Setup ---
        const initialize = () => {
            const savedTimers = JSON.parse(localStorage.getItem('flow-timers'));
            if (savedTimers) timers = savedTimers;
            document.getElementById('pomodoro-duration').value = timers.pomodoro;
            document.getElementById('shortbreak-duration').value = timers.shortBreak;
            document.getElementById('longbreak-duration').value = timers.longBreak;
            
            // Ambient sound preference removed

            // Thème initial: préférence utilisateur > préférence système > clair
            const savedTheme = localStorage.getItem(THEME_STORAGE_KEY);
            const initialTheme = savedTheme ?? (window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches ? 'dark' : 'light');
            applyTheme(initialTheme, Boolean(savedTheme));

            document.querySelectorAll('.mode-btn, .control-btn, .setting-input').forEach(el => {
                if (el.tagName === 'INPUT') el.classList.add('bg-transparent', 'border', 'rounded-lg', 'w-20', 'text-center', 'py-1', 'focus:outline-none', 'focus:ring-2', 'focus:ring-white/50');
                else el.classList.add('px-4', 'py-2', 'rounded-full', 'font-semibold', 'transition-all', 'duration-300', 'ease-in-out', 'focus:outline-none', 'focus:ring-2', 'focus:ring-white/50');
            });
            document.querySelectorAll('.cycle-dot').forEach(dot => dot.classList.add('w-3', 'h-3', 'rounded-full', 'transition-colors', 'duration-500'));
            
            state.timeRemaining = timers.pomodoro * 60;
            updateDisplay();
            updateCounterUI();
            updateUIForState();
        };

        initialize();
    </script>
</body>
</html>
